name: 'C++ Printer Firmware CI/CD Pipeline'

on:
  push:
    branches: [ main, master, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: 'Deployment environment'
        required: false
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      skip_tests:
        description: 'Skip test execution'
        required: false
        default: false
        type: boolean

# =============================================================================
# Environment Variables and Configuration
# =============================================================================
env:
  CMAKE_VERSION: '3.22'
  BUILD_TYPE: Release
  COVERAGE_THRESHOLD: 90
  DOCKER_REGISTRY: ghcr.io
  IMAGE_NAME: printer-firmware-simulator

# =============================================================================
# Workflow Jobs
# =============================================================================
jobs:
  # ---------------------------------------------------------------------------
  # Job 1: Code Quality and Security Analysis
  # ---------------------------------------------------------------------------
  code-analysis:
    name: 'ğŸ” Code Analysis & Security'
    runs-on: ubuntu-22.04
    permissions:
      security-events: write
      contents: read
    
    steps:
    - name: 'ğŸ“¥ Checkout Repository'
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis
    
    - name: 'ğŸ”§ Setup Build Environment'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git libgtest-dev
        
    - name: 'ğŸ›¡ï¸ Initialize CodeQL Analysis'
      uses: github/codeql-action/init@v3
      with:
        languages: cpp
        config-file: ./.github/codeql/codeql-config.yml
        
    - name: 'ğŸ—ï¸ Build for Analysis'
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug
        cmake --build build --parallel $(nproc)
        
    - name: 'ğŸ” Perform CodeQL Analysis'
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:cpp"
        
    - name: 'ğŸ”’ Dependency Vulnerability Scan'
      uses: ossf/scorecard-action@v2.3.1
      with:
        results_file: results.sarif
        results_format: sarif
        publish_results: true

  # ---------------------------------------------------------------------------
  # Job 2: Multi-Platform Build and Test Matrix
  # ---------------------------------------------------------------------------
  build-and-test:
    name: 'ğŸ—ï¸ Build & Test'
    runs-on: ${{ matrix.os }}
    needs: code-analysis
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-20.04]
        compiler: [gcc, clang]
        build_type: [Debug, Release]
        include:
          - compiler: gcc
            cc: gcc
            cxx: g++
          - compiler: clang
            cc: clang
            cxx: clang++
    
    steps:
    - name: 'ğŸ“¥ Checkout Repository'
      uses: actions/checkout@v4
      
    - name: 'ğŸ’¾ Cache CMake Build'
      uses: actions/cache@v4
      with:
        path: |
          build
          ~/.cache/cmake
        key: ${{ runner.os }}-${{ matrix.compiler }}-${{ matrix.build_type }}-${{ hashFiles('**/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-${{ matrix.compiler }}-${{ matrix.build_type }}-
          ${{ runner.os }}-${{ matrix.compiler }}-
          
    - name: 'ğŸ”§ Install Dependencies'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git libgtest-dev lcov
        
        # Build and install GoogleTest
        cd /usr/src/gtest
        sudo cmake . -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
        sudo make
        sudo cp lib/*.a /usr/lib/ || sudo cp *.a /usr/lib/
        
    - name: 'âš™ï¸ Configure CMake'
      env:
        CC: ${{ matrix.cc }}
        CXX: ${{ matrix.cxx }}
      run: |
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
          -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage"
          
    - name: 'ğŸ—ï¸ Build Project'
      run: |
        cmake --build build --config ${{ matrix.build_type }} --parallel $(nproc)
        
    - name: 'ğŸ§ª Run Unit Tests'
      if: ${{ !inputs.skip_tests }}
      run: |
        cd build
        ctest --output-on-failure --parallel $(nproc) --verbose
        
    - name: 'ğŸ“Š Generate Coverage Report'
      if: matrix.compiler == 'gcc' && matrix.build_type == 'Debug'
      run: |
        # Generate initial coverage data
        lcov --capture --directory build --output-file coverage.info
        
        # Filter out system headers and test files
        lcov --remove coverage.info '/usr/*' --output-file coverage.info
        lcov --remove coverage.info '*/tests/*' --output-file coverage.info
        lcov --remove coverage.info '*/build/*' --output-file coverage.info
        
        # Generate HTML report
        genhtml coverage.info --output-directory coverage_html
        
        # Check coverage threshold
        COVERAGE=$(lcov --summary coverage.info | grep lines | grep -o '[0-9.]*%' | head -1 | sed 's/%//')
        echo "Coverage: ${COVERAGE}%"
        
        if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
          echo "âŒ Coverage ${COVERAGE}% is below threshold ${COVERAGE_THRESHOLD}%"
          exit 1
        else
          echo "âœ… Coverage ${COVERAGE}% meets threshold ${COVERAGE_THRESHOLD}%"
        fi
        
    - name: 'ğŸ“¤ Upload Coverage to Codecov'
      if: matrix.compiler == 'gcc' && matrix.build_type == 'Debug'
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: true
        
    - name: 'ğŸ“¦ Upload Build Artifacts'
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ matrix.os }}-${{ matrix.compiler }}-${{ matrix.build_type }}
        path: |
          build/printer
          build/test_printer
        retention-days: 7
        
    - name: 'ğŸ“Š Upload Coverage Report'
      if: matrix.compiler == 'gcc' && matrix.build_type == 'Debug'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage_html/
        retention-days: 30
