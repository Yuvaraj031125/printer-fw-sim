# Printer Firmware CI Workflow
# Purpose: Automates build, test, and artifact packaging for printer firmware simulation.
# This workflow builds the C++ printer firmware simulator, runs comprehensive unit tests,
# generates code coverage reports, and packages the firmware binary for distribution.
#
# Configuration Instructions:
# - Ensure the repository contains CMakeLists.txt in the root directory
# - Source files should be in src/ directory (main.cpp, printer.cpp, printer.h)
# - Test files should be in tests/ directory (test_printer.cpp)
# - The workflow expects GoogleTest framework for unit testing
# - Coverage reports are generated using lcov and gcov
#
# Troubleshooting Guide:
# - If build fails: Check cmake version (minimum 3.10), verify C++17 compiler support
# - If dependencies fail: Ensure Ubuntu package repositories are accessible
# - If tests fail: Review ctest output for specific test failures, check GoogleTest installation
# - If coverage fails: Verify gcov is available and source files have coverage flags
# - If artifact upload fails: Confirm 'build/printer' executable exists after successful build
# - If gtest build fails: Check /usr/src/gtest directory permissions and cmake availability
#
# Configuration Template (uncomment and modify as needed):
# env:
#   CMAKE_BUILD_TYPE: Debug
#   FIRMWARE_BINARY_PATH: build/printer
#   COVERAGE_OUTPUT_DIR: build/coverage
#   ARTIFACT_NAME: printer-firmware
#   GTEST_COLOR: 1

name: Printer Firmware CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source
        uses: actions/checkout@v3
        
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ libgtest-dev lcov
          cd /usr/src/gtest
          sudo cmake .
          sudo make
          sudo cp lib/*.a /usr/lib
          
      - name: Build with coverage
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS="--coverage" ..
          make
          
      - name: Run tests
        run: |
          cd build
          ctest --output-on-failure
          
      - name: Package firmware artifact
        run: |
          tar -cvf printer-firmware.tar build/printer
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: printer-firmware
          path: printer-firmware.tar
